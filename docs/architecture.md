# Архитектура приложения

## Общее описание

Gophermart - это система лояльности, построенная на принципах чистой архитектуры с разделением на слои. Приложение обеспечивает регистрацию пользователей, загрузку номеров заказов, учет баллов лояльности и вывод средств.

## Структура проекта

```bash
gophermart/
├── cmd/                    # Точки входа приложения
│   └── gophermart/        # Основной сервис
├── internal/              # Внутренний код приложения
│   ├── app/              # Инициализация и конфигурация приложения
│   ├── domain/           # Модели и интерфейсы
│   ├── handlers/         # HTTP обработчики
│   ├── repository/       # Слой работы с БД
│   ├── service/          # Сервисный слой
│   ├── utils/            # Вспомогательные утилиты
│   └── worker/           # Фоновые задачи и воркеры
├── migrations/           # Миграции БД
└── docs/                 # Документация
```

## Слои приложения

### 1. Presentation Layer (handlers)

- HTTP обработчики для обработки входящих запросов
- Валидация входных данных с помощью validator
- Сериализация/десериализация JSON
- Обработка ошибок и формирование HTTP ответов
- Middleware компоненты (аутентификация, логирование)

### 2. Business Layer (service)

- Реализация бизнес-логики
- Координация работы репозиториев
- Управление транзакциями
- Взаимодействие с внешней системой начисления баллов
- Обработка бизнес-правил и валидаций

### 3. Data Layer (repository)

- Работа с PostgreSQL через pgx и sqlx
- Реализация CRUD операций
- Управление транзакциями на уровне БД
- Маппинг данных между БД и domain моделями

### 4. Domain Layer

- Определение основных сущностей (User, Order, Balance)
- Интерфейсы для репозиториев и сервисов
- Бизнес-правила и константы
- Типы ошибок предметной области

### 5. Background Workers

- Обработка заказов в фоновом режиме
- Периодическая синхронизация с системой начисления баллов
- Управление очередями и отложенными задачами

## Основные компоненты

### Аутентификация

- JWT токены для авторизации пользователей
- Middleware авторизации для защиты эндпоинтов
- Хеширование паролей с помощью bcrypt

### База данных

- PostgreSQL для хранения данных
- Миграции с помощью goose
- Транзакционная целостность

### Внешние интеграции

- Система начисления баллов (Accrual System)
- Асинхронное обновление статусов заказов
- Retry механизмы при сбоях

### Логирование

- Структурированное логирование с помощью slog
  - Уровни логирования (debug, info, warn, error)
  - Контекстная информация в логах
  - Логирование HTTP запросов и ответов
- Отслеживание ошибок и исключительных ситуаций
  - Ошибки взаимодействия с БД
  - Ошибки внешних интеграций
  - Ошибки бизнес-логики.
